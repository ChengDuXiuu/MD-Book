## IP: 网际协议

####定义
IP（Internet Protocol）协议，又称网际协议，它负责Internet上网络之间的通信，并规定了将数据从一个网络传输到另一个网络应遵循的规则，是TCP/IP协议的核心。因特网利用IP协议把全世界所有愿意接入因特网的计算机局域网连接起来，使得它们彼此之间都能够通信。

>IP协议具有能适应多样化网络硬件的灵活性，任何一个网络只要可以从一个地点向另一个地点传送二进制数据，就可以使用IP协议加入因特网。但是连接在因特网上的每台计算机如果想进行交流和通信，还必须遵守IP协议。

#### 功能
IP的主要目的是通过一个互联的网络传输数据报，涉及两个最基本的功能。

- 寻址(Addressing)：IP协议根据数据报首部中包括的目的地址将数据报传送到目的节点，这就要涉及传送路径的选择，即路由功能。IP协议使用IP地址来实现路由。

- 分片(Fragmentation)：IP协议还提供对数据大小的分片和重组，以适应不同网络对数据包大小的限制。如果网络只能传送小数据包，IP协议将对数据报进行分段并重新组成小块再进行传送。

#### 特点

* 不可靠 :不能保证IP数据报能够成功的到达目的地，IP仅能提供最好的传输服务，如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法:丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须有上层来提供(例如TCP的断点重发等)

* 无连接 :IP报并不为维护和关于后续数据包的状态信息，每个数据报的处理都是相互独立的。即IP数据报可以不按发送顺序接受 。

* 作为一种点对点协议，虽然IP数据报携带源IP地址和目的IP地址，但进行数据传输时的对等实体一定是相邻设备(同一网络)中的对等实体。

* IP协议的效率非常高，实现起来也较简单。这是因为IP协议采用了尽力传输的思想，随着底层网络质量的日益提高，IP协议的尽力传输的优势体现得更加明显。

###IP首部

![失效](/media/shuaibi/_dde_data/Respository/MD-Book/网络/资料/IP首部.jpg)
<center>IP首部-结构图</center>

1. 第一个4字节（也就是第一行）：

    * 版本号（Version），4位；用于标识IP协议版本，IPv4是0100，IPv6是0110，也就是二进制的4和6。

    * 首部长度（Internet Header Length），4位；用于标识首部的长度，单位为4字节，所以首部长度最大值为：(2^4 - 1) * 4 = 60字节，但一般只推荐使用20字节的固定长度。

    * 服务类型（Type Of Service），8位；用于标识IP包的优先级，但现在并未使用。

    * 总长度（Total Length），16位；标识IP数据报的总长度，最大为：2^16 -1 = 65535字节。

2. 第二个四字节：

    * 标识（Identification），16位；用于标识IP数据报，如果因为数据链路层帧数据段长度限制（也就是MTU，支持的最大传输单元），IP数据报需要进行分片发送，则每个分片的IP数据报标识都是一致的。

    * 标识（Flag），3位，但目前只有2位有意义；最低位为MF，MF=1代表后面还有分片的数据报，MF=0代表当前数据报已是最后的数据报。次低位为DF，DF=1代表不能分片，DF=0代表可以分片。

    * 片偏移（Fragment Offset），13位；代表某个分片在原始数据中的相对位置。

3. 第三个四字节：
    * 生存时间（TTL），8位；以前代表IP数据报最大的生存时间，现在标识IP数据报可以经过的路由器数。
    * 协议（Protocol），8位；代表上层传输层协议的类型，1代表ICMP，2代表IGMP，6代表TCP，17代表UDP。
    * 校验和（Header Checksum），16位；用于验证数据完整性，计算方法为，首先将校验和位置零，然后将每16位二进制反码求和即为校验和，最后写入校验和位置。

4. 第四个四字节：源IP地址

5. 第五个四字节：目的IP地址
