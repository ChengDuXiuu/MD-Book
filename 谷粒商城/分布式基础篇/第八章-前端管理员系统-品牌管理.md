## 人人逆向工程反向vue代码

将src/components/upload 下三个封装后的文件拷贝进项目

修改multiUpload.vue中地址 为Bucket 域名



`前端vue代码`

1.  将逆向生成的 brand.vue  和 brand-add-or-update.vue  拷贝到  src/views/modules/product目录下

2.  封装js

    ```javascript
    # src/api/product/brand.js
    
    import request from "@/utils/httpRequest"
    const BASE_URL = "/product/brand"
    
    /**
     * 品牌列表
     * @param {*} params
     */
    export function BrandListApi(params){
      return request({
          url:  request.adornUrl( `${BASE_URL}/list`) ,
          method: "get",
          params : request.adornParams(params , false )
      })
    }
    export function BrandInfoApi(brandId){
      return request({
          url:  request.adornUrl( `${BASE_URL}/info/${brandId}`) ,
          method: "get"
      })
    }
    /**
     * 修改品牌状态
     * @param {*} data
     */
    export function BrandUpdateStatusApi(data) {
      return request({
        url: request.adornUrl(`${BASE_URL}/update/status`),
        method: "put",
        data: request.adornData(data, false)
      })
    }
    /**
     * 删除品牌
     * @param {Array} data
     */
    export function BrandDeleteApi(data) {
      return request({
        url: request.adornUrl(`${BASE_URL}/save`),
        method: "delete",
        data: request.adornData(data, false)
      })
    }
    ```

    ```javascript
    # src/api/product/categoryBrandRelation.js
    import request from "@/utils/httpRequest"
    const BASE_URL = "/product/categorybrandrelation"
    
    export function CategoryBrandRelationSaveApi(data) {
      return request({
        url: request.adornUrl(`${BASE_URL}/info/${categoryId}`),
        method: "get",
        data: request.adornData(data, false)
      })
    }
    export function CategoryBrandRelationDeleteApi(data) {
      return request({
        url: request.adornUrl(`${BASE_URL}/delete`),
        method: "delete",
        data: request.adornData(data, false)
      })
    }
    export function CategoryBrandRelationCategoryListApi(brandId) {
      return request({
        url: request.adornUrl(`${BASE_URL}/category/list`),
        method: "get",
        params: request.adornParams({ brandId })
      })
    }
    
    export function CategoryBrandRelationCategoryBrandListApi(categoryId) {
      return request({
        url: request.adornUrl(`${BASE_URL}/brands/list`),
        method: "get",
        params: request.adonParams({ categoryId })
      })
    }
    ```



2.  暂时关闭renren-vue前台项目的权限校验

    ```javascript
    # src/utils/index.js
    export function isAuth (key) {
      return true;
      // return JSON.parse(sessionStorage.getItem('permissions') || '[]').indexOf(key) !== -1 || false
    }
    ```

3.  封装上传代码

    ```vue
    #src/components/upload/singleUpload.vue
    <template>
    <div>
      <el-upload  :action="dataObj.host" :data="dataObj" list-type="picture" :multiple="false" :show-file-list="showFileList" :file-list="fileList" :before-upload="beforeUpload" :on-remove="handleRemove" :on-success="handleUploadSuccess" :on-preview="handlePreview">
        <el-button size="small" type="primary">点击上传</el-button>
        <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过10MB</div>
      </el-upload>
      <el-dialog :visible.sync="dialogVisible">
        <img width="100%" :src="fileList[0].url" alt="">
      </el-dialog>
    </div>
    </template>
    
    <script>
    import { policy } from './policy'
    import { getUUID } from '@/utils'
    
    export default {
      name: 'singleUpload',
      props: {
        value: String
      },
      computed: {
        imageUrl() {
          return this.value;
        },
        imageName() {
          if (this.value != null && this.value !== '') {
            return this.value.substr(this.value.lastIndexOf("/") + 1);
          } else {
            return null;
          }
        },
        fileList() {
          return [{
            name: this.imageName,
            url: this.imageUrl
          }]
        },
        showFileList: {
          get: function () {
            return this.value !== null && this.value !== '' && this.value !== undefined;
          },
          set: function (newValue) {}
        }
      },
      data() {
        return {
          dataObj: {
            policy: '',
            signature: '',
            key: '',
            ossaccessKeyId: '',
            dir: '',
            host: 'gulimall-shuai.oss-cn-beijing.aliyuncs.com',
            // callback:'',
          },
          dialogVisible: false
        };
      },
      methods: {
        emitInput(val) {
          this.$emit('input', val)
        },
        handleRemove(file, fileList) {
          this.emitInput('');
        },
        handlePreview(file) {
          this.dialogVisible = true;
        },
        beforeUpload(file) {
          let _self = this;
          return new Promise((resolve, reject) => {
            console.log("获取签名后的数据 > >")
            policy().then(response => {
              _self.dataObj.policy = response.data.data.policy;
              _self.dataObj.signature = response.data.data.signature;
              _self.dataObj.ossaccessKeyId = response.data.data.accessid;
              _self.dataObj.key = response.data.data.dir + '/' + getUUID() + '_${filename}';
              _self.dataObj.dir = response.data.data.dir;
              _self.dataObj.host = response.data.data.host;
              resolve(true)
            }).catch(err => {
              reject(false)
            })
          })
        },
        handleUploadSuccess(res, file) {
          console.log("上传成功...")
          this.showFileList = true;
          this.fileList.pop();
          this.fileList.push({ name: file.name, url: this.dataObj.host + '/' + this.dataObj.key.replace("${filename}", file.name) });
          this.emitInput(this.fileList[0].url);
        }
      }
    }
    </script>
    
    <style>
    
    </style>
    ```

    ```vue
    #src/components/upload/multiUpload.vue
    <template>
    <div>
      <el-upload :action="dataObj.host"  :data="dataObj" list-type="picture-card" :file-list="fileList" :before-upload="beforeUpload" :on-remove="handleRemove" :on-success="handleUploadSuccess" :on-preview="handlePreview" :limit="maxCount" :on-exceed="handleExceed">
        <i class="el-icon-plus"></i>
      </el-upload>
      <el-dialog :visible.sync="dialogVisible">
        <img width="100%" :src="dialogImageUrl" alt />
      </el-dialog>
    </div>
    </template>
    
    <script>
    import { policy } from "./policy";
    import { getUUID } from '@/utils'
    export default {
      name: "multiUpload",
      props: {
        //图片属性数组
        value: Array,
        //最大上传图片数量
        maxCount: {
          type: Number,
          default: 30
        }
      },
      data() {
        return {
          dataObj: {
            policy: "",
            signature: "",
            key: "",
            ossaccessKeyId: "",
            dir: "",
            host: "gulimall-shuai.oss-cn-beijing.aliyuncs.com",
            uuid: ""
          },
          dialogVisible: false,
          dialogImageUrl: null
        };
      },
      computed: {
        fileList() {
          let fileList = [];
          for (let i = 0; i < this.value.length; i++) {
            fileList.push({ url: this.value[i] });
          }
    
          return fileList;
        }
      },
      mounted() {},
      methods: {
        emitInput(fileList) {
          let value = [];
          for (let i = 0; i < fileList.length; i++) {
            value.push(fileList[i].url);
          }
          this.$emit("input", value);
        },
        handleRemove(file, fileList) {
          this.emitInput(fileList);
        },
        handlePreview(file) {
          this.dialogVisible = true;
          this.dialogImageUrl = file.url;
        },
        beforeUpload(file) {
          let _self = this;
          return new Promise((resolve, reject) => {
            policy()
              .then(response => {
                console.log(response) ;
                console.log("这是什么${filename}");
                _self.dataObj.policy = response.data.policy;
                _self.dataObj.signature = response.data.signature;
                _self.dataObj.ossaccessKeyId = response.data.accessid;
                _self.dataObj.key = response.data.dir + "/" + getUUID() + "_${filename}";
                _self.dataObj.dir = response.data.dir;
                _self.dataObj.host = response.data.host;
                resolve(true);
              })
              .catch(err => {
                console.log("出错了...", err)
                reject(false);
              });
          });
        },
        handleUploadSuccess(res, file) {
          this.fileList.push({
            name: file.name,
            // url: this.dataObj.host + "/" + this.dataObj.dir + "/" + file.name； 替换${filename}为真正的文件名
            url: this.dataObj.host + "/" + this.dataObj.key.replace("${filename}", file.name)
          });
          this.emitInput(this.fileList);
        },
        handleExceed(files, fileList) {
          this.$message({
            message: "最多只能上传" + this.maxCount + "张图片",
            type: "warning",
            duration: 1000
          });
        }
      }
    };
    </script>
    
    <style>
    </style>
    
    ```

    ```javascript
    # src/components/upload/policy.js
    import http from '@/utils/httpRequest.js'
    export function policy() {
       return  new Promise((resolve,reject)=>{
            http({
                url: http.adornUrl("/thirdparty/oss/policy"),
                method: "get"
            }).then((data) => {
                console.log(data)
                resolve(data);
            })
        });
    }
    ```

    



`后端代码`











## 重点 -  图片 - 云存储

>   因为这里涉及到多个服务，如果仅仅将图片、视频等资源存放在某一个服务下，则其他服务就存在找不到的风险，因此使用一个公共服务器进行存储。

![image-20210222215919354](第八章-前端管理员系统-品牌管理.assets/image-20210222215919354.png)

>   这里使用  云存储作为 文件存储服务器



`详情参考` ：MD-Book\Spring Cloud Alibaba\第五章-阿里云存储OSS.md

>   因为 第五章-阿里云存储OSS.md 是之前的笔记，现在为了回炉重造，因此重新做整合 OSS 笔记





## Spring Cloud整合 Aliyun Spring Boot OSS

> 上面都是使用的阿里云提供的 OSS-SDK最原始的sdk 。需要配置好多东西。
>
> 这里以  `gulimall-Product` 微服务 演示

1. 加入依赖

    ```xml
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>aliyun-spring-boot-dependencies</artifactId>
                <version>1.0.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <dependency>
         <groupId>com.alibaba.cloud</groupId>
         <artifactId>aliyun-oss-spring-boot-starter</artifactId>
    </dependency>
    ```


​	

2.  Nacos配置中心  

    >   配置文件 之前已全部整合到了 配置中心 因此 在 Nacos 中新建 oss.yml 配置文件，并在bootstrap.properties 中新增配置集

    *   新增配置集 oss.yml

    ![image-20210223201733611](第八章-前端管理员系统-品牌管理.assets/image-20210223201733611.png)

    ```yaml
    alibaba:
      cloud:
        #用户登录名称 gulimall-new@1170427993785276.onaliyun.com
        #AccessKey ID LTAI4FzRdEuN34dQA9QLnTcs
        #AccessKey Secret E9HzBswmUvtqsQSOeebCe0N2xYwKZ3
        access-key: LTAI4FzRdEuN34dQA9QLnTcs
        secret-key: E9HzBswmUvtqsQSOeebCe0N2xYwKZ3
        oss:
          endpoint: oss-cn-beijing.aliyuncs.com
    ```

    

    *   bootstrap.properties 中新增配置集 

        ```properties
        spring.cloud.nacos.config.ext-config[4].data-id=oss.yml
        spring.cloud.nacos.config.ext-config[4].group=dev
        spring.cloud.nacos.config.ext-config[4].refresh=true
        ```
    
    
    
3. 测试

    ```java
    @RunWith(SpringRunner.class)
    @SpringBootTest
    public class Client {
        @Autowired
        OSSClient ossClient;//注入阿里云存储 对象
        /*
         * TODO <p> 测试阿里云文件上传功能</p>
         * @author mac
         * @date 2020/9/20 5:49 下午
         * @param null
         * @return
         * @see #
         */
        @Test
        public void testUpload() throws FileNotFoundException {
    //        // Endpoint以杭州为例，其它Region请按实际情况填写。 endpoint 为Bucket 的外网访问地址
    //        String endpoint = "oss-cn-beijing.aliyuncs.com";
    //         // 阿里云主账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建RAM账号。
    //        String accessKeyId = "LTAI4G6NvVQoR4ErbYKVabCW";
    //        String accessKeySecret = "O7sRW85fwf25tkuWmf9QvbpE8EaRX1";
    
            // 创建OSSClient实例。
    //        OSS ossClient = new OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);
    
            // 上传文件流。
            InputStream inputStream = new FileInputStream("C:\\Users\\gao17\\Pictures\\1.jpg");
            ossClient.putObject("gulimall-shuai", "test3.jpg", inputStream);
    
            // 关闭OSSClient。
            ossClient.shutdown();
    
            System.out.println("上传完成");
        }
    }
    ```

    

4. ![image-20200920213652069](../../Spring Cloud Alibaba/第五章-阿里云存储OSS.assets/image-20200920213652069.png)

5. ![image-20200920213706088](../../Spring Cloud Alibaba/第五章-阿里云存储OSS.assets/image-20200920213706088.png)



## 新建微服务 gulimall-third-party

1.  root项目中添加 新加的微服务模块

2.  pom文件中填入 `gulimall-Common`服务依赖 引入 服务注册发现依赖包

    ```xml
    <properties>
    	<!-- 保持一致 -->
        <spring-boot.version>2.3.7.RELEASE</spring-boot.version>
        <spring-cloud.version>Hoxton.SR9</spring-cloud.version>
    </properties>
    
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>aliyun-spring-boot-dependencies</artifactId>
                <version>1.0.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
    <dependency>
        <groupId>com.shuai.gulimall</groupId>
        <artifactId>gulimall-common</artifactId>
        <version>0.0.1-SNAPSHOT</version>
        <exclusions>
            <exclusion>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>aliyun-oss-spring-boot-starter</artifactId>
    </dependency>
    ```

    

3.  nacos 新建 命名空间

    ![image-20210223211201097](第八章-前端管理员系统-品牌管理.assets/image-20210223211201097.png)

4.  克隆 Product 命名空间 配置文件到 Third-Party 下  一定要包含 oss.yml文件 否则新建一个。

    ![image-20210223211519966](第八章-前端管理员系统-品牌管理.assets/image-20210223211519966.png)

4.  修改配置文件中项目名和端口号(9006)

5.  新建bootstrap.properties 配置 nacos配置集

    ```properties
    # 指定服务名称
    spring.application.name=gulimall-Third-Party
    # 指定配置中心IP
    spring.cloud.nacos.config.server-addr=127.0.0.1:8848
    # 指定命名空间
    spring.cloud.nacos.config.namespace=0a2adf3c-8ea7-4bd7-97a7-00d60286869a
    # 指定分组
    #spring.cloud.nacos.config.group=dev
    # 指定配置文件类型
    #spring.cloud.nacos.config.file-extension=yml
    # 加载多个配置集
    # 配置文件
    spring.cloud.nacos.config.ext-config[0].data-id=oss.yml
    # 分组
    spring.cloud.nacos.config.ext-config[0].group=dev
    # 是否刷新
    spring.cloud.nacos.config.ext-config[0].refresh=true
    
    
    spring.cloud.nacos.config.ext-config[1].data-id=spring.yml
    spring.cloud.nacos.config.ext-config[1].group=dev
    spring.cloud.nacos.config.ext-config[1].refresh=true
    ```

6.  开启服务的注册发现

    ```java
    @EnableDiscoveryClient
    @SpringBootApplication
    public class GulimallThirdPartyApplication {
    
        public static void main(String[] args) {
            SpringApplication.run(GulimallThirdPartyApplication.class, args);
        }
    
    }
    ```

8.  测试

    ```java
    @RunWith(SpringRunner.class)
    @SpringBootTest
    public class Client {
        @Autowired
        OSSClient ossClient;//注入阿里云存储 对象
        /*
         * TODO <p> 测试阿里云文件上传功能</p>
         * @author mac
         * @date 2020/9/20 5:49 下午
         * @param null
         * @return
         * @see #
         */
        @Test
        public void testUpload() throws FileNotFoundException {
    //        // Endpoint以杭州为例，其它Region请按实际情况填写。 endpoint 为Bucket 的外网访问地址
    //        String endpoint = "oss-cn-beijing.aliyuncs.com";
    //         // 阿里云主账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建RAM账号。
    //        String accessKeyId = "LTAI4G6NvVQoR4ErbYKVabCW";
    //        String accessKeySecret = "O7sRW85fwf25tkuWmf9QvbpE8EaRX1";
    
            // 创建OSSClient实例。
    //        OSS ossClient = new OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);
    
            // 上传文件流。
            InputStream inputStream = new FileInputStream("C:\\Users\\gao17\\Pictures\\1.jpg");
            ossClient.putObject("gulimall-shuai", "test66.jpg", inputStream);
    
            // 关闭OSSClient。
            ossClient.shutdown();
    
            System.out.println("上传完成");
        }
    }
    ```

    





## 服务端签名后直传

>   在`gulimall-Third-Party`服务基础上改造



1.  新增OssController ：提供签名

    ```java
    package com.shuai.gulimall.thirdparty.controller;
    /**
     * TODO:<p>  <p/>
     *
     * @Author mac
     * @Date 2020/9/20 10:20 下午
     * @Version V1.0
     **/
    @RestController
    @RequestMapping("/oss")
    public class OssController {
    
        @Autowired
        OSS ossClient;
    
        @Value("${alibaba.cloud.oss.endpoint}")
        private String endpoint;
    
        @Value("${alibaba.cloud.oss.bucket}")
        private String bucket;
    
        @Value("${alibaba.cloud.access-key}")
        private String accessId;
    
    
        @RequestMapping("/listTree")
        public R listTree(@RequestParam Map<String, Object> params) {
            return R.ok().put("data", "entities");
        }
    
        @RequestMapping("/policy")
        public R policy() {
            String host = "https://" + bucket + "." + endpoint; // host的格式为 bucketname.endpoint
            // callbackUrl为 上传回调服务器的URL，请将下面的IP和Port配置为您自己的真实信息。
    //        String callbackUrl = "http://88.88.88.88:8888";
    
            String format = new SimpleDateFormat("yyyy-MM-dd").format(new Date());
    
            String dir = format + "/"; // 用户上传文件时指定的前缀。每次上传文件都生成一个目录存放文件
    
            // 创建OSSClient实例。
    //        OSS ossClient = new OSSClientBuilder().build(endpoint, accessId, accessKey);
            Map<String, String> respMap = null;
            try {
                long expireTime = 30;
                long expireEndTime = System.currentTimeMillis() + expireTime * 1000;
                Date expiration = new Date(expireEndTime);
                // PostObject请求最大可支持的文件大小为5 GB，即CONTENT_LENGTH_RANGE为5*1024*1024*1024。
                PolicyConditions policyConds = new PolicyConditions();
                policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000);
                policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);
    
                String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);
                byte[] binaryData = postPolicy.getBytes("utf-8");
                String encodedPolicy = BinaryUtil.toBase64String(binaryData);
                String postSignature = ossClient.calculatePostSignature(postPolicy);
    
                respMap = new LinkedHashMap<String, String>();
                respMap.put("accessid", accessId);
                respMap.put("policy", encodedPolicy);
                respMap.put("signature", postSignature);
                respMap.put("dir", dir);
                respMap.put("host", host);
                respMap.put("expire", String.valueOf(expireEndTime / 1000));
                // respMap.put("expire", formatISO8601Date(expiration));
    
            } catch (Exception e) {
                // Assert.fail(e.getMessage());
                System.out.println(e.getMessage());
            } finally {
                ossClient.shutdown();
            }
            return R.ok().put("data", respMap);
        }
    
    }
    ```
    
2.  配置文件

   ```yaml
   alibaba:
     cloud:
       #用户登录名称 gulimall-new@1170427993785276.onaliyun.com
       #AccessKey ID LTAI4FzRdEuN34dQA9QLnTcs
       #AccessKey Secret E9HzBswmUvtqsQSOeebCe0N2xYwKZ3
       access-key: LTAI4FzRdEuN34dQA9QLnTcs
       secret-key: E9HzBswmUvtqsQSOeebCe0N2xYwKZ3
       oss:
         endpoint: oss-cn-beijing.aliyuncs.com
   ```

   

3.  测试

   ![image-20210224205012640](第八章-前端管理员系统-品牌管理.assets/image-20210224205012640.png)

   >   Osscontroller返回的内容就是我们日后要发给云存储服务器的签名  然后带着签名以及文件上传到云存储

4.  `gulimall-Gateway`新增 `gulimall-Third-Party`路径映射

    ```yaml
          - id: third_party_route # 第三方服务
            uri: lb://gulimall-Third-Party
            predicates:
              - Path=/api/thirdparty/**   #路由规则
            filters:
              - RewritePath=/api/thirdparty/(?<segment>.*),/$\{segment}  # 路径重写
    ```

5.  重启网关服务  验证通过网关是否成功

    ![image-20210224205737926](第八章-前端管理员系统-品牌管理.assets/image-20210224205737926.png)

    >   /api/thirdparty  为路由匹配规则   segment  为具体请求 - 对应controller中请求

6.  前后台联调  ： 跨域问题

    >   从我们 88 网关服务器  post 阿里云 不同源

7.  阿里云开启跨域

![image-20200921205348792](../../Spring Cloud Alibaba/第五章-阿里云存储OSS.assets/image-20200921205348792.png)

![image-20200921205444525](../../Spring Cloud Alibaba/第五章-阿里云存储OSS.assets/image-20200921205444525.png)

![image-20200921211113391](../../Spring Cloud Alibaba/第五章-阿里云存储OSS.assets/image-20200921211113391.png)

![image-20200921211252508](../../Spring Cloud Alibaba/第五章-阿里云存储OSS.assets/image-20200921211252508.png)





## 前后端校验

### 前端校验

```vue
<el-form :rules="dataRule"></el-form>
```

```vue
return{
	dataRule: {
        name: [{ required: true, message: "品牌名不能为空", trigger: "blur" }],
        logo: [
          { required: true, message: "品牌logo地址不能为空", trigger: "blur" }
        ],
        descript: [
          { required: true, message: "介绍不能为空", trigger: "blur" }
        ],
        showStatus: [{
          required: true,
          message: "显示状态[0-不显示；1-显示]不能为空",
          trigger: "blur"
        }],
        firstLetter: [{
          validator: (rule, value, callback) => {
            if (value == "") {
              callback(new Error("首字母必须填写"));
            } else if (!/^[a-zA-Z]$/.test(value)) {
              callback(new Error("首字母必须a-z或者A-Z之间"));
            } else {
              callback();
            }
          },
          trigger: "blur"
        }],
        sort: [{
          validator: (rule, value, callback) => {
            if (value === "") {
              callback(new Error("排序字段必须填写"));
            } else if (!Number.isInteger(value) || value < 0) {
              callback(new Error("排序必须是一个大于等于0的整数"));
            } else {
              callback();
            }
          },
          trigger: "blur"
        }]
      }
    };
  },
}
```



### 后端校验

>   参考 ：MD-Book\SpringBoot\Web开发\第四章-Spring Boot参数校验Validation入门.md   <font color=ff00aa>添加 BindingResult 获取实体类校验错误信息</font>

1.  导包

    ```xml
    <properties>
        <validation.version>2.0.1.Final</validation.version>
    </properties>
    <!-- 参数校验 -->
    <dependency>
        <groupId>javax.validation</groupId>
        <artifactId>validation-api</artifactId>
        <version>${validation.version}</version>
    </dependency>
    <dependency>
        <groupId>org.hibernate.validator</groupId>
        <artifactId>hibernate-validator</artifactId>
    </dependency>
    ```

    

2.  标注校验注解 @Valid

    ```java
    #存库前进行实体类校验
    @RequestMapping("/save")
    public R save(@Valid @RequestBody BrandEntity brand) {
        brandService.save(brand);
    
        return R.ok();
    }
    ```

3.  实体类校验规则

    ```java
    @Data
    @TableName("pms_brand")
    public class BrandEntity implements Serializable {
        private static final long serialVersionUID = 1L;
    
        /**
         * 品牌id
         */
        @TableId
        private Long brandId;
        /**
         * 品牌名
         */
        @NotBlank(message = "品牌名必须提交")
        private String name;
        /**
         * 品牌logo地址
         */
        @NotEmpty
        @URL(message = "品牌地址必须是一个URL")
        private String logo;
        /**
         * 介绍
         */
        private String descript;
        /**
         * 显示状态[0-不显示；1-显示]
         */
        @NotNull
        private Integer showStatus;
        /**
         * 检索首字母
         */
        //自定义校验规则，必须匹配正则表达式
        @NotEmpty
        @Pattern(regexp = "/^[a-zA-Z]$/",message = "检索首字母必须是一个字母")
        private String firstLetter;
        /**
         * 排序
         */
        @NotNull
        @Min(value = 0,message = "给定排序必须大于0")
        private Integer sort;
    
    }
    ```

    

4.  获取校验错误信息并返回前台

    ```java
        @RequestMapping("/save")
        public R save(@Valid @RequestBody BrandEntity brand , BindingResult bindingResult) {
            // 1. BindingResult 获取实体类所有的校验错误信息 全部返回
            if (bindingResult.hasErrors()){
                Map<String,String> map = new HashMap<>();
    
                //2. 获取校验错误提示
                bindingResult.getFieldErrors().forEach((item) ->{
                    //错误提示信息
                    String mess = item.getDefaultMessage();
                    //获取错误的属性名称
                    String field = item.getField();
                    map.put(field,mess);
                });
                return R.error(400,"提交的数据不合法~").put("data",map);
            }else {
                brandService.save(brand);
            }
    
            return R.ok();
        }
    ```

    





































进度  ：  前端项目缺少依赖、修改了单文件上传 Bucket 域名  安装pubsub-js 报错   前后台联调